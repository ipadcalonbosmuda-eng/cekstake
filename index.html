<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hedged Farming Tracker — Base Dipinjam (Loaned)</title>
<style>
  :root { --bg:#0b0f13; --card:#141a21; --text:#e8eef6; --muted:#9db0c2; --accent:#4fd1c5; --bad:#ff7878; --good:#8be28b;}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{padding:18px 20px;text-align:center;border-bottom:1px solid #1e2630;background:linear-gradient(180deg,#0f141a,#0b0f13)}
  main{max-width:980px;margin:22px auto;padding:0 14px 60px}
  h1{margin:0;font-size:20px}
  h2{font-size:15px;margin:0 0 10px;color:var(--muted);font-weight:700}
  .card{background:var(--card);border:1px solid #1f2933;border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
  input{width:100%;padding:11px;border-radius:10px;background:#0d1217;border:1px solid #243140;color:var(--text);font-size:14px}
  input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(79,209,197,.12)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{cursor:pointer;background:var(--accent);color:#052b27;border:0;border-radius:10px;padding:10px 14px;font-weight:700}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0f171f;border:1px solid #223041;color:var(--muted);font-size:12px}
  .kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:8px}
  .kpi .item{background:#0f141a;border:1px solid #1f2a35;border-radius:12px;padding:14px}
  .kpi .label{font-size:12px;color:var(--muted)}
  .kpi .value{font-size:22px;margin-top:6px}
  .ok{color:var(--good)} .warn{color:var(--bad)}
  .small{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header>
  <h1>Hedged Farming Tracker (Base Dipinjam)</h1>
  <div class="small">Hitung PnL bersih saat base (mis. CARV) kamu <b>pinjam</b>, jadi yang kamu “miliki” ya <b>USDC</b>-nya. Harga live: DexScreener + Binance (ETH).</div>
</header>

<main>
  <div class="card">
    <h2>1) Pair & Harga</h2>
    <div class="grid">
      <div style="grid-column: span 2;">
        <label>DexScreener Pair URL (mis. CARV/USDC atau ZORA/WETH)</label>
        <input id="pairUrl" value="https://dexscreener.com/base/0xff862675c47b6a2c9072dcbe2f37a78a445c4f37" />
      </div>
      <div>
        <label>Refresh interval (detik)</label>
        <input id="intervalSec" value="15" />
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="refresh">Refresh harga</button>
      <span class="pill" id="status">Idle</span>
    </div>
  </div>

  <div class="card">
    <h2>2) Modal Awal & Posisi Sekarang</h2>
    <div class="grid">
      <div>
        <label>Modal awal kamu (USDC saja)</label>
        <input id="initialUsd" value="318" />
      </div>
      <div>
        <label>Jumlah base sekarang (mis. CARV)</label>
        <input id="baseNow" value="22930" />
      </div>
      <div>
        <label>Jumlah quote sekarang (USDC / WETH)</label>
        <input id="quoteNow" value="0" />
      </div>
      <div>
        <label><input type="checkbox" id="isLoaned" checked /> Base dipinjam (hedged)</label>
        <input id="baseDebt" value="22930" />
        <div class="small">Isi utang base (token). Kalau perfect hedge → sama dengan base yang kamu pegang/LP.</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>3) Ringkasan Live</h2>
    <div class="kpi">
      <div class="item"><div class="label">Pair terdeteksi</div><div class="value" id="kpiPair">–</div></div>
      <div class="item"><div class="label">Harga Base (USD)</div><div class="value" id="kpiBaseUsd">$ –</div></div>
      <div class="item"><div class="label">Harga Quote (USD)</div><div class="value" id="kpiQuoteUsd">$ –</div></div>
      <div class="item"><div class="label">Net Exposure Base</div><div class="value" id="kpiNetBase">–</div></div>
      <div class="item"><div class="label">Nilai Bersih Portofolio</div><div class="value" id="kpiNetUsd">$ –</div></div>
      <div class="item"><div class="label">PNL vs Modal Awal</div><div class="value" id="kpiPnL">$ –</div></div>
    </div>
  </div>

  <div class="card">
    <h2>4) Jika Bayar Utang Sekarang</h2>
    <div class="kpi">
      <div class="item"><div class="label">Surplus Base</div><div class="value" id="kpiSurplusBase">–</div></div>
      <div class="item"><div class="label">Kekurangan Base</div><div class="value" id="kpiDeficitBase">–</div></div>
      <div class="item"><div class="label">USDC dibutuhkan untuk lunasi</div><div class="value" id="kpiNeedUsd">$ –</div></div>
      <div class="item"><div class="label">USDC tersisa setelah lunasi</div><div class="value" id="kpiLeftUsd">$ –</div></div>
    </div>
  </div>
</main>

<script>
const $ = (id)=>document.getElementById(id);
function parseFlex(v){ v=String(v??'').trim().replace(/\s/g,'').replace(',', '.'); if(!v) return NaN; const n=Number(v); return isFinite(n)?n:NaN; }
function fmt(n,d=6){ if(!isFinite(n)) return '–'; return Number(n).toLocaleString(undefined,{maximumFractionDigits:d}); }
function setStatus(s){ $('status').textContent=s; }

async function fetchEthUsd(){
  try{
    const r = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=ETHUSDT',{cache:'no-store'});
    const j = await r.json(); const px = Number(j.price);
    if(!isFinite(px)) throw new Error(); return px;
  }catch(e){ return NaN; }
}
async function fetchPair(){
  const url = $('pairUrl').value.trim();
  const u = new URL(url);
  const [chain,pair] = u.pathname.split('/').filter(Boolean);
  const r = await fetch(`https://api.dexscreener.com/latest/dex/pairs/${chain}/${pair}`, {cache:'no-store'});
  return r.json(); // {pair:{priceUsd, baseToken{symbol}, quoteToken{symbol}}}
}

async function refreshNow(){
  try{
    setStatus('Ambil harga…');
    const j = await fetchPair();
    const baseUsd  = Number(j?.pair?.priceUsd);
    const baseSym  = (j?.pair?.baseToken?.symbol || '').toUpperCase();
    const quoteSym = (j?.pair?.quoteToken?.symbol || '').toUpperCase();
    if(!isFinite(baseUsd) || !baseSym || !quoteSym) throw new Error('bad pair');

    // quote USD
    let quoteUsd = 1;
    if(['USDC','USDT','USDCE','USDC.E','DAI'].includes(quoteSym)){ quoteUsd = 1; }
    else if(['WETH','ETH'].includes(quoteSym)){ quoteUsd = await fetchEthUsd(); }
    else { const qp = Number(j?.pair?.quotePriceUsd); if(isFinite(qp)) quoteUsd = qp; }

    // inputs
    const initialUsd = parseFlex($('initialUsd').value);
    const baseNow = parseFlex($('baseNow').value);
    const quoteNow= parseFlex($('quoteNow').value);
    const isLoaned = $('isLoaned').checked;
    const baseDebt = parseFlex($('baseDebt').value);

    if(![initialUsd,baseNow,quoteNow].every(isFinite)) return;

    $('kpiPair').textContent = `${baseSym}/${quoteSym}`;
    $('kpiBaseUsd').textContent = '$ ' + fmt(baseUsd,6);
    $('kpiQuoteUsd').textContent = '$ ' + fmt(quoteUsd,6);

    // Net exposure & net worth
    const netBase = isLoaned && isFinite(baseDebt) ? baseNow - baseDebt : baseNow; // token
    const netUsd  = quoteNow * quoteUsd + netBase * baseUsd; // portofolio bersih setelah mengakui utang
    const pnlUsd  = netUsd - initialUsd; // karena modal awal = USDC saja

    $('kpiNetBase').textContent = `${fmt(netBase)} ${baseSym} (${netBase>=0?'+':''}${fmt(netBase*baseUsd,2)} USD)`;
    $('kpiNetUsd').textContent = '$ ' + fmt(netUsd,2);
    $('kpiPnL').textContent = (pnlUsd>=0?'+':'') + '$ ' + fmt(pnlUsd,2);

    // Repay simulation now
    let surplusBase = 0, deficitBase = 0, needUsd = 0, leftUsd = quoteNow * quoteUsd;
    if(isLoaned && isFinite(baseDebt)){
      const diff = baseNow - baseDebt;
      if(diff >= 0){
        surplusBase = diff;
        needUsd = 0;
        leftUsd = quoteNow * quoteUsd; // semua utang lunas pakai base sendiri
      }else{
        deficitBase = Math.abs(diff);
        needUsd = deficitBase * baseUsd;
        leftUsd = quoteNow * quoteUsd - needUsd;
      }
    }

    $('kpiSurplusBase').textContent = surplusBase ? `${fmt(surplusBase)} ${baseSym} ($ ${fmt(surplusBase*baseUsd,2)})` : '0';
    $('kpiDeficitBase').textContent = deficitBase ? `${fmt(deficitBase)} ${baseSym} ($ ${fmt(deficitBase*baseUsd,2)})` : '0';
    $('kpiNeedUsd').textContent     = '$ ' + fmt(needUsd,2);
    $('kpiLeftUsd').textContent     = '$ ' + fmt(leftUsd,2);

    setStatus('Live OK');
  }catch(e){
    console.error(e);
    setStatus('Fetch fail');
  }
}

$('refresh').addEventListener('click', refreshNow);
['pairUrl','initialUsd','baseNow','quoteNow','isLoaned','baseDebt'].forEach(id=>{
  $(id).addEventListener('input', refreshNow);
});

let timer=null;
function startAuto(){
  if(timer) clearInterval(timer);
  const sec = Math.max(5, parseInt($('intervalSec').value || '15', 10));
  timer = setInterval(refreshNow, sec*1000);
}
$('intervalSec').addEventListener('input', startAuto);

// init
refreshNow();
startAuto();
</script>
</body>
</html>
