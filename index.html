<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Portfolio Hedged Tracker — Multi Token (DexScreener)</title>
<style>
  :root{--bg:#0b0f13;--card:#141a21;--text:#e8eef6;--muted:#9db0c2;--accent:#4fd1c5;--bad:#ff7878;--good:#8be28b}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;background:var(--bg);color:var(--text)}
  header{padding:18px 20px;text-align:center;border-bottom:1px solid #1e2630;background:linear-gradient(180deg,#0f141a,#0b0f13)}
  main{max-width:1100px;margin:22px auto;padding:0 14px 60px}
  h1{margin:0;font-size:20px}
  h2{font-size:15px;margin:0 0 10px;color:var(--muted);font-weight:700}
  .card{background:var(--card);border:1px solid #1f2933;border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
  input{width:100%;padding:11px;border-radius:10px;background:#0d1217;border:1px solid #243140;color:var(--text);font-size:14px}
  input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(79,209,197,.12)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{cursor:pointer;background:var(--accent);color:#052b27;border:0;border-radius:10px;padding:10px 14px;font-weight:700}
  .btn.secondary{background:#0f171f;color:var(--muted);border:1px solid #223041}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0f171f;border:1px solid #223041;color:var(--muted);font-size:12px}
  .ok{color:var(--good)} .warn{color:var(--bad)}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  th,td{padding:12px 14px;text-align:left}
  th{color:var(--muted);font-weight:600}
  tr.cardrow{background:#0f141a;border:1px solid #1f2a35}
  tr.cardrow td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tr.cardrow td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .small{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header>
  <h1>Portfolio Hedged Tracker</h1>
  <div class="pill">Harga: DexScreener pair • ETH/USDT: Binance</div>
</header>

<main>
  <div class="card">
    <h2>Tambah Posisi</h2>
    <div class="grid">
      <div style="grid-column:span 2">
        <label>DexScreener Pair URL (contoh: https://dexscreener.com/base/0xff86...)</label>
        <input id="pairUrl" />
      </div>
      <div>
        <label>Nama (opsional)</label>
        <input id="name" placeholder="CARV farming / ZORA LP" />
      </div>
      <div>
        <label>Modal awal kamu (USD) — dana sendiri</label>
        <input id="initialUsd" value="0" />
      </div>
      <div>
        <label>Base sekarang (token)</label>
        <input id="baseNow" value="0" />
      </div>
      <div>
        <label>Quote sekarang (USDC/WETH/…)</label>
        <input id="quoteNow" value="0" />
      </div>
      <div>
        <label><input type="checkbox" id="isLoaned" /> Base dipinjam?</label>
        <input id="baseDebt" value="0" />
        <div class="small">Isi utang base (token). Kalau hedged total → ≈ baseNow.</div>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="add">Tambah ke daftar</button>
      <button class="btn secondary" id="clearAll">Hapus semua</button>
      <span class="pill" id="status">Idle</span>
    </div>
  </div>

  <div class="card">
    <h2>Daftar Posisi</h2>
    <div id="list"></div>
  </div>
</main>

<script>
/* ==== helpers ==== */
const $ = (id)=>document.getElementById(id);
function parseFlex(v){ v=String(v??'').trim().replace(/\s/g,'').replace(',', '.'); if(!v) return NaN; const n=Number(v); return isFinite(n)?n:NaN; }
function fmt(n,d=6){ if(!isFinite(n)) return '–'; return Number(n).toLocaleString(undefined,{maximumFractionDigits:d}); }
function setStatus(s){ $('status').textContent=s; }
const STOR='hedged_positions_v1';
const load=()=>{try{return JSON.parse(localStorage.getItem(STOR)||'[]')}catch{return[]}};
const save=(s)=>localStorage.setItem(STOR,JSON.stringify(s));

/* ==== price fetch ==== */
async function fetchEthUsd(){
  try{
    const r=await fetch('https://api.binance.com/api/v3/ticker/price?symbol=ETHUSDT',{cache:'no-store'});
    const j=await r.json(); const px=Number(j.price); return isFinite(px)?px:NaN;
  }catch{ return NaN }
}
async function fetchPairData(pairUrl){
  const u=new URL(pairUrl);
  const [chain,pair]=u.pathname.split('/').filter(Boolean);
  const r=await fetch(`https://api.dexscreener.com/latest/dex/pairs/${chain}/${pair}`,{cache:'no-store'});
  return r.json(); // {pair:{priceUsd, baseToken, quoteToken, quotePriceUsd}}
}

/* ==== compute ==== */
async function compute(p){
  const j = await fetchPairData(p.pairUrl);
  const baseUsd = Number(j?.pair?.priceUsd);
  const baseSym = (j?.pair?.baseToken?.symbol||'BASE').toUpperCase();
  const quoteSym= (j?.pair?.quoteToken?.symbol||'QUOTE').toUpperCase();
  if(!isFinite(baseUsd)) throw new Error('price missing');

  let quoteUsd = 1;
  if(['USDC','USDT','USDCE','USDC.E','DAI'].includes(quoteSym)){ quoteUsd=1; }
  else if(['WETH','ETH'].includes(quoteSym)){ quoteUsd=await fetchEthUsd(); }
  else { const qp=Number(j?.pair?.quotePriceUsd); if(isFinite(qp)) quoteUsd=qp; }

  const baseNow=parseFlex(p.baseNow), quoteNow=parseFlex(p.quoteNow), initUsd=parseFlex(p.initialUsd);
  const debt = p.isLoaned ? parseFlex(p.baseDebt) : 0;

  const netBase = (p.isLoaned && isFinite(debt)) ? (baseNow - debt) : baseNow; // token
  const netUsd  = quoteNow*quoteUsd + netBase*baseUsd;                         // nilai bersih
  const pnlUsd  = isFinite(initUsd) ? (netUsd - initUsd) : NaN;

  // repay simulation (kalau base dipinjam)
  let surplusBase=0, deficitBase=0, needUsd=0, leftUsd=quoteNow*quoteUsd;
  if(p.isLoaned && isFinite(debt)){
    const diff = baseNow - debt;
    if(diff>=0){ surplusBase=diff; }
    else { deficitBase=Math.abs(diff); needUsd=deficitBase*baseUsd; leftUsd -= needUsd; }
  }

  return {baseSym,quoteSym,baseUsd,quoteUsd,netBase,netUsd,pnlUsd,surplusBase,deficitBase,needUsd,leftUsd};
}

/* ==== UI ==== */
async function render(){
  const arr=load(); const root=$('list'); root.innerHTML='';
  if(arr.length===0){ root.innerHTML='<div class="small">Belum ada posisi. Tambah di atas.</div>'; return; }

  for(let i=0;i<arr.length;i++){
    const p=arr[i]; let data=null, err=null;
    try{ data=await compute(p); }catch(e){ err=e; }

    const card=document.createElement('div'); card.className='card';
    const title = p.name || 'Posisi ' + (i+1);
    const head = `
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700">${title}</div>
          <div class="small"><a href="${p.pairUrl}" target="_blank" style="color:#8bbbd0;text-decoration:none">${p.pairUrl}</a></div>
        </div>
        <div class="row">
          <button class="btn secondary" data-edit="${i}">Edit</button>
          <button class="btn secondary" data-del="${i}">Hapus</button>
        </div>
      </div>`;
    card.insertAdjacentHTML('beforeend', head);

    const body=document.createElement('div'); body.style.marginTop='12px';
    if(!data){
      body.innerHTML='<span class="pill">Fetch gagal — cek URL / rate limit</span>';
    }else{
      body.innerHTML = `
      <table>
        <thead><tr><th>Metrix</th><th>Nilai</th><th>Keterangan</th></tr></thead>
        <tbody>
          <tr class="cardrow"><td>Pair</td><td>${data.baseSym}/${data.quoteSym}</td><td>Base/Quote</td></tr>
          <tr class="cardrow"><td>Harga ${data.baseSym}</td><td>$ ${fmt(data.baseUsd,6)}</td><td>DexScreener</td></tr>
          <tr class="cardrow"><td>Harga ${data.quoteSym}</td><td>$ ${fmt(data.quoteUsd,6)}</td><td>${['USDC','USDT','DAI'].includes(data.quoteSym)?'stable ~ 1':'live'}</td></tr>
          <tr class="cardrow"><td>Net Exposure Base</td><td>${fmt(data.netBase)} ${data.baseSym}</td><td>${arr[i].isLoaned?'(baseNow - debt)':'baseNow'}</td></tr>
          <tr class="cardrow"><td>Nilai Bersih Portofolio</td><td>$ ${fmt(data.netUsd,2)}</td><td>Quote + NetBase×Harga</td></tr>
          <tr class="cardrow"><td>PNL vs Modal USD</td><td>${data.pnlUsd>=0?'<span class="ok">+ $ '+fmt(data.pnlUsd,2)+'</span>':'<span class="warn">- $ '+fmt(Math.abs(data.pnlUsd),2)+'</span>'}</td><td>Modal: $ ${fmt(parseFlex(p.initialUsd),2)}</td></tr>
          <tr class="cardrow"><td>Surplus Base (setelah tebus)</td><td>${fmt(data.surplusBase)} ${data.baseSym}</td><td>$ ${fmt(data.surplusBase*data.baseUsd,2)}</td></tr>
          <tr class="cardrow"><td>Kekurangan Base (untuk lunasi)</td><td>${fmt(data.deficitBase)} ${data.baseSym}</td><td>$ ${fmt(data.needUsd,2)} diperlukan</td></tr>
          <tr class="cardrow"><td>USDC tersisa sesudah lunasi</td><td>$ ${fmt(data.leftUsd,2)}</td><td>Estimasi</td></tr>
        </tbody>
      </table>`;
    }
    card.appendChild(body);
    root.appendChild(card);

    card.querySelector(`[data-del="${i}"]`).onclick=()=>{ const s=load(); s.splice(i,1); save(s); render(); };
    card.querySelector(`[data-edit="${i}"]`).onclick=()=>{
      $('pairUrl').value=p.pairUrl; $('name').value=p.name||'';
      $('initialUsd').value=p.initialUsd||'0'; $('baseNow').value=p.baseNow||'0'; $('quoteNow').value=p.quoteNow||'0';
      $('isLoaned').checked=!!p.isLoaned; $('baseDebt').value=p.baseDebt||'0'; window.scrollTo({top:0,behavior:'smooth'});
    };
  }
}

/* ==== add / clear ==== */
$('add').onclick=()=>{
  const obj={
    pairUrl:$('pairUrl').value.trim(),
    name:$('name').value.trim(),
    initialUsd:$('initialUsd').value.trim(),
    baseNow:$('baseNow').value.trim(),
    quoteNow:$('quoteNow').value.trim(),
    isLoaned:$('isLoaned').checked,
    baseDebt:$('baseDebt').value.trim()
  };
  if(!obj.pairUrl){ setStatus('URL pair wajib diisi'); return; }
  const s=load(); s.push(obj); save(s); setStatus('Ditambahkan'); render();
};
$('clearAll').onclick=()=>{ save([]); render(); setStatus('Semua posisi dihapus'); };

/* ==== auto refresh ==== */
let timer=null;
async function loop(){
  await render();
  if(timer) clearTimeout(timer);
  timer=setTimeout(loop, 20*1000);
}
loop();
</script>
</body>
</html>
