<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hedged Composition Calculator — Base Dipinjam (DexScreener)</title>
<style>
  :root{--bg:#0b0f13;--card:#141a21;--text:#e8eef6;--muted:#9db0c2;--accent:#4fd1c5;--bad:#ff7878;--good:#8be28b}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;background:var(--bg);color:var(--text)}
  header{padding:18px 20px;text-align:center;border-bottom:1px solid #1e2630;background:linear-gradient(180deg,#0f141a,#0b0f13)}
  main{max-width:980px;margin:22px auto;padding:0 14px 60px}
  h1{margin:0;font-size:20px}
  h2{font-size:15px;margin:0 0 10px;color:var(--muted);font-weight:700}
  .card{background:var(--card);border:1px solid #1f2933;border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
  input{width:100%;padding:11px;border-radius:10px;background:#0d1217;border:1px solid #243140;color:var(--text);font-size:14px}
  input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(79,209,197,.12)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{cursor:pointer;background:var(--accent);color:#052b27;border:0;border-radius:10px;padding:10px 14px;font-weight:700}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0f171f;border:1px solid #223041;color:var(--muted);font-size:12px}
  .kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:8px}
  .kpi .item{background:#0f141a;border:1px solid #1f2a35;border-radius:12px;padding:14px}
  .kpi .label{font-size:12px;color:var(--muted)}
  .kpi .value{font-size:22px;margin-top:6px}
  .ok{color:var(--good)} .warn{color:var(--bad)}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  th,td{padding:12px 14px;text-align:left}
  th{color:var(--muted);font-weight:600}
  tr.cardrow{background:#0f141a;border:1px solid #1f2a35}
  tr.cardrow td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tr.cardrow td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .small{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header>
  <h1>Hedged Composition Calculator (Base Dipinjam)</h1>
  <div class="small">Masukkan URL DexScreener pair. Kalkulasi fokus ke <b>USDC milikmu</b> & kewajiban <b>mengembalikan base token</b> (CARV dll).</div>
</header>

<main>
  <div class="card">
    <h2>1) Pair & Harga</h2>
    <div class="grid">
      <div style="grid-column:span 2">
        <label>DexScreener Pair URL (contoh: https://dexscreener.com/base/0xff86...)</label>
        <input id="pairUrl" />
      </div>
      <div>
        <label>Refresh interval (detik)</label>
        <input id="intervalSec" value="15" />
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="refresh">Refresh harga</button>
      <span class="pill" id="status">Idle</span>
    </div>
  </div>

  <div class="card">
    <h2>2) Modal & Kewajiban</h2>
    <div class="grid">
      <div>
        <label>Modal awal kamu (USDC)</label>
        <input id="initialUsdc" value="0" />
      </div>
      <div>
        <label>Utang base (token) yang wajib dikembalikan</label>
        <input id="baseDebt" value="0" />
      </div>
    </div>
    <div class="small">Contoh: kamu minjem 10,000 CARV → isi 10000 di “utang base”.</div>
  </div>

  <div class="card">
    <h2>3) Posisi Sekarang</h2>
    <div class="grid">
      <div>
        <label>Base sekarang (token)</label>
        <input id="baseNow" value="0" />
      </div>
      <div>
        <label>Quote sekarang (USDC/WETH/...)</label>
        <input id="quoteNow" value="0" />
      </div>
      <div>
        <label>Biaya swap % (opsional, mis. 0.3)</label>
        <input id="feePct" value="0" />
      </div>
    </div>
  </div>

  <div class="card">
    <h2>4) Ringkasan</h2>
    <div class="kpi">
      <div class="item"><div class="label">Pair</div><div class="value" id="kpiPair">–</div></div>
      <div class="item"><div class="label">Harga Base (USD)</div><div class="value" id="kpiBaseUsd">$ –</div></div>
      <div class="item"><div class="label">Harga Quote (USD)</div><div class="value" id="kpiQuoteUsd">$ –</div></div>
      <div class="item"><div class="label">Base short/surplus</div><div class="value" id="kpiBaseGap">–</div></div>
      <div class="item"><div class="label">USDC dibutuhkan/tersisa utk lunasi</div><div class="value" id="kpiUsdcNeedLeft">$ –</div></div>
      <div class="item"><div class="label">Net USDC jika ditutup</div><div class="value" id="kpiNetUsdc">$ –</div></div>
      <div class="item"><div class="label">PnL vs modal USDC</div><div class="value" id="kpiPnl">$ –</div></div>
    </div>
  </div>

  <div class="card">
    <h2>5) Rincian Rugi/Laba</h2>
    <table>
      <thead>
        <tr><th>Item</th><th>Qty</th><th>USD</th><th>Keterangan</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</main>

<script>
const $ = (id)=>document.getElementById(id);
function parseFlex(v){ v=String(v??'').trim().replace(/\s/g,'').replace(',', '.'); if(!v) return NaN; const n=Number(v); return isFinite(n)?n:NaN; }
function fmt(n,d=6){ if(!isFinite(n)) return '–'; return Number(n).toLocaleString(undefined,{maximumFractionDigits:d}); }
function setStatus(s){ $('status').textContent=s; }

async function fetchEthUsd(){
  try{
    const r=await fetch('https://api.binance.com/api/v3/ticker/price?symbol=ETHUSDT',{cache:'no-store'});
    const j=await r.json(); const px=Number(j.price); return isFinite(px)?px:NaN;
  }catch{ return NaN }
}
async function fetchPair(){
  const url=$('pairUrl').value.trim(); if(!url) throw new Error('Pair URL kosong');
  const u=new URL(url); const [chain,pair]=u.pathname.split('/').filter(Boolean);
  const r=await fetch(`https://api.dexscreener.com/latest/dex/pairs/${chain}/${pair}`,{cache:'no-store'});
  return r.json(); // {pair:{priceUsd, baseToken, quoteToken, quotePriceUsd?}}
}

function row(label, qty, usd, note){
  const tr=document.createElement('tr'); tr.className='cardrow';
  tr.innerHTML=`<td>${label}</td><td>${qty}</td><td>${usd}</td><td>${note||''}</td>`;
  return tr;
}

async function refreshNow(){
  try{
    setStatus('Ambil harga…');
    const j = await fetchPair();
    const baseSym  = (j?.pair?.baseToken?.symbol||'BASE').toUpperCase();
    const quoteSym = (j?.pair?.quoteToken?.symbol||'QUOTE').toUpperCase();
    const baseUsd  = Number(j?.pair?.priceUsd);
    if(!isFinite(baseUsd)) throw new Error('Harga base tidak valid');

    // Harga quote (USDC=1, WETH=Binance, else: coba quotePriceUsd)
    let quoteUsd=1;
    if(['USDC','USDT','DAI','USDCE','USDC.E'].includes(quoteSym)){ quoteUsd=1; }
    else if(['WETH','ETH'].includes(quoteSym)){ quoteUsd=await fetchEthUsd(); }
    else { const qp=Number(j?.pair?.quotePriceUsd); if(isFinite(qp)) quoteUsd=qp; }

    // Inputs
    const initialUsdc = parseFlex($('initialUsdc').value);
    const baseDebt    = parseFlex($('baseDebt').value);
    const baseNow     = parseFlex($('baseNow').value);
    const quoteNow    = parseFlex($('quoteNow').value);
    const feePct      = Math.max(0, parseFlex($('feePct').value)||0)/100;
    if(![initialUsdc,baseDebt,baseNow,quoteNow].every(isFinite)) { setStatus('Isi semua angka'); return; }

    // Gap base (positif = kekurangan token base yg harus ditebus)
    const baseGap = baseDebt - baseNow;          // >0 short, <0 surplus
    const baseGapAbs = Math.abs(baseGap);

    // USDC needed/left to fully repay the debt (apply fee on the side you trade)
    // Kalau short base → beli base: biaya di-apply pada USDC yang dipakai
    const usdcNeededRaw = (baseGap>0) ? baseGap * baseUsd : 0;
    const usdcNeeded    = (baseGap>0) ? usdcNeededRaw * (1 + feePct) : 0;

    // Kalau surplus base → bisa dijual ke USDC, biaya di-apply pada hasil
    const usdcFromSurplusRaw = (baseGap<0) ? baseGapAbs * baseUsd : 0;
    const usdcFromSurplus    = (baseGap<0) ? usdcFromSurplusRaw * (1 - feePct) : 0;

    const quoteUsdNow = quoteNow * quoteUsd;

    // Net USDC jika ditutup sekarang (setelah repay sampai pas lunas)
    // rumus umum: USDC_now + (base_now - baseDebt)*price_base, lalu terapkan fee kira-kira:
    const netUsdcIfClose = quoteUsdNow + (baseNow - baseDebt) * baseUsd
                           - (baseGap>0 ? feePct*usdcNeededRaw : 0)
                           - (baseGap<0 ? feePct*usdcFromSurplusRaw : 0);

    // PnL vs modal USDC
    const pnl = netUsdcIfClose - initialUsdc;

    // Render KPI
    $('kpiPair').textContent = `${baseSym}/${quoteSym}`;
    $('kpiBaseUsd').textContent  = '$ ' + fmt(baseUsd,6);
    $('kpiQuoteUsd').textContent = '$ ' + fmt(quoteUsd,6);
    $('kpiBaseGap').textContent  = (baseGap>0?`Short ${fmt(baseGap)} ${baseSym}`: baseGap<0?`Surplus ${fmt(baseGapAbs)} ${baseSym}`:'Pas (0)');
    $('kpiUsdcNeedLeft').textContent = baseGap>0
      ? (`Butuh $ ` + fmt(usdcNeeded,2))
      : baseGap<0
        ? (`Tersedia $ ` + fmt(usdcFromSurplus,2))
        : '$ 0.00';
    $('kpiNetUsdc').textContent = '$ ' + fmt(netUsdcIfClose,2);
    $('kpiPnl').textContent = (pnl>=0?'+ ':'- ') + '$ ' + fmt(Math.abs(pnl),2);
    $('kpiPnl').className = 'value ' + (pnl>=0?'ok':'warn');

    // Table detail
    const tb=$('tbody'); tb.innerHTML='';
    tb.appendChild(row(`Kekurangan/Surplus ${baseSym}`, 
      baseGap>0?`${fmt(baseGap)} ${baseSym}`: baseGap<0?`${fmt(baseGapAbs)} ${baseSym}`:'0', 
      '$ '+fmt(baseGapAbs*baseUsd,2),
      baseGap>0?'Harus dibeli untuk lunas':'Surplus jika dilunasi sekarang'
    ));
    tb.appendChild(row('USDC sekarang (quote)', fmt(quoteNow)+' '+quoteSym, '$ '+fmt(quoteUsdNow,2), 'Milikmu'));
    if(baseGap>0){
      tb.appendChild(row('USDC dibutuhkan untuk beli base', '—', '$ '+fmt(usdcNeeded,2), feePct?`Termasuk fee ~${(feePct*100).toFixed(2)}%`:''));
      tb.appendChild(row('Sisa/kurang USDC setelah lunasi',
        '—',
        '$ '+fmt(quoteUsdNow - usdcNeeded,2),
        (quoteUsdNow>=usdcNeeded?'✅ Cukup USDC':'❌ USDC kurang, perlu tambah')
      ));
    }else if(baseGap<0){
      tb.appendChild(row(`USDC dari jual surplus ${baseSym}`, '—', '$ '+fmt(usdcFromSurplus,2), feePct?`Neto sesudah fee`:''));
      tb.appendChild(row('USDC total setelah lunasi', '—', '$ '+fmt(quoteUsdNow + usdcFromSurplus,2), 'Estimasi jika surplus dijual'));
    }
    tb.appendChild(row('Net USDC jika ditutup sekarang', '—', '$ '+fmt(netUsdcIfClose,2), 'Quote + (Base-utang)×harga (termasuk fee kira-kira)'));
    tb.appendChild(row('PnL vs modal USDC', '—', (pnl>=0?'+ ':'- ')+'$ '+fmt(Math.abs(pnl),2), pnl>=0?'Profit (USDC)':'Rugi (USDC)'));

    setStatus('Live OK');
  }catch(e){
    console.error(e);
    setStatus('Fetch gagal / input belum lengkap');
  }
}

$('refresh').addEventListener('click', refreshNow);
['pairUrl','initialUsdc','baseDebt','baseNow','quoteNow','feePct'].forEach(id=>$(id).addEventListener('input', refreshNow));

// auto refresh
let timer=null;
function startAuto(){
  if(timer) clearInterval(timer);
  const sec=Math.max(5, parseInt(($('intervalSec').value||'15'),10));
  timer=setInterval(refreshNow,sec*1000);
}
$('intervalSec').addEventListener('input', startAuto);

// init
refreshNow(); startAuto();
</script>
</body>
</html>
